---
title: "GLM of SEV scores"
author: "Jenn_McHenry"
date: "December 1, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(MASS)
library(car)
library(modEvA)
library(betareg)
library(gamlss)
```

# Initial examination of x and y parameters
```{r cars}
dat <- read.csv("vulnerability_covariates.csv")

head(dat)

summary(dat)
```

```{r visualizing data distribution}

head(dat)
names(dat)

boxplot(dat[c(3:8)])

#Normality test
?shapiro.test
shapiro.test(dat$eco_sens) #normal
shapiro.test(dat$eco_recov) #normal 
shapiro.test(dat$eco_vul) #normal
shapiro.test(dat$soc_sen) #normal
shapiro.test(dat$soc_ac) #non-normal if using 0.05, normal if using 0.01
shapiro.test(dat$se_vul) #non-normal if using 0.05, normal if using 0.01

```

## Ecological Sensitivity

```{r Ecologial Sensitivity, echo=TRUE}
dat_select < -dat %>%
  na.omit() %>%
  dplyr::select(eco_sens, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

summary(dat_select$eco_exp)
```

### Gaussian error structure (Ecological Sensitivity)
```{r}
### Set null model (no covariates)
null <- glm(eco_sens ~ 1, data = dat_select, family = gaussian(link = "identity"))

### Build model with all covariates included
gaussian <- glm(eco_sens ~ ., data = dat_select, family = gaussian(link = "identity"))

### Assess model fit
Dsquared(gaussian)
RsqGLM(gaussian) # This is an approximation for an Rsqard

### Check for multicollinearity
vif(gaussian) # values for each variable closer to one indicate no multicollinearity.  Higher values closer to 10 indicate the variable may be correlated with another explanatory variable.

### Visualize full model
plot(gaussian) #all Xs included
summary(gaussian) #all Xs included

#Comparing new model to the null
anova(null, gaussian, test = "Chisq")  # an increase in residual deviance and a non-significant pvalue is a non-significant improvement

#model adequacy (values above 0.05 make an adequate model)
pchisq(0.085511-0.057259, gaussian$df.null-gaussian$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables
stepAIC(gaussian, direction = "both")

#g2
gaussian2 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score, 
                 data = dat_select, family = gaussian(link = "identity"))
Dsquared(gaussian2) # this is the explained deviance
RsqGLM(gaussian2) #This is an approximation for an Rsqard
plot(gaussian2) #plots for lower AIC model
summary(gaussian2) #summary of lowest AIC model

#g3 (model with lowest AIC)
gaussian3 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot, 
                 data = dat_select, family = gaussian(link = "identity"))
Dsquared(gaussian3) # less explained deviance than the null
RsqGLM(gaussian3) #This is an approximation for an Rsqard
plot(gaussian3) #plots for lower AIC model
summary(gaussian3) #summary of lowest AIC model

drop1(gaussian3) # just a check to make sure you shouldn't remove any more

#Comparing new models to the null
anova(null, gaussian2, gaussian3, test = "Chisq")  # an increase in residual deviance and a non-significant pvalue is a non-significant improvement from the previous model. When there isn't much of an improvment but the p values in the summary table are non-significant then should always pick the simplest model. 

### Assign Gaussian best model
gaussian_best <- gaussian3
summary(gaussian_best)
cr.plots(gaussian_best)
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.058281, gaussian_best$df.residual, lower.tail = FALSE)
```

### Quasibinomial error structure (Ecological Sensitivity)
```{r}
### Set full model using QB error structure
QB <- glm(eco_sens ~ ., data = dat_select, family = quasibinomial) # Model with all Xs included
Dsquared(QB)
RsqGLM(QB) #This is an approximation for an Rsqard
plot(QB) #all Xs included
summary.glm(QB) #all Xs 

anova(null, QB, test = "Chisq")  # an increase in deviance means a non-significant model, a high pvalue is a non-significant model

#model adequacy (values above 0.05 make an adequate model)
pchisq(0.37664, QB$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables of full QB model
drop1(QB)  ##have to do it this way rather than stepAIC because apparently AIC can't be calculated from a QB model. If removal of a term increases the residual deviance, then it is not the best variable to remove

#QB2
QB2 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score,
           data = dat_select,family = quasibinomial)
Dsquared(QB2)
RsqGLM(QB2) #This is an approximation for an Rsqard
summary(QB2)
anova(QB, QB2, test = "Chisq") # an increase in deviance means a non-significant model, a high pvalue is a non-significant model
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.3767, QB2$df.residual, lower.tail = FALSE)

drop1(QB2)

#QB3
QB3=glm(eco_sens ~ eez_percent_prot + coral_percent_prot,
        data = dat_select,family = quasibinomial)
Dsquared(QB3)
RsqGLM(QB3) #This is an approximation for an Rsqard
summary(QB3)
pchisq(0.3860, QB2$df.residual, lower.tail = FALSE) #model adequacy (values above 0.05 make an adequate model)


drop1(QB3)

QB_best=QB3
anova(null, QB_best, test = "Chisq") # an increase in deviance means a non-significant model, a high pvalue is a non-significant model
```

### Beta error structure (Ecological Sensitivity)
```{r}
BetaGLM <- betareg(eco_sens ~., data = dat_select) 
plot(BetaGLM) #all Xs included
summary(BetaGLM) #all Xs 

#I couldn't find a stepwise function for beta-regression so I did it by hand just looking at the p values and the coefficients. 
BetaGLM2 <- betareg(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score, data = dat_select) 
summary(BetaGLM2)

BetaGLM3 <- betareg(eco_sens ~ eez_percent_prot + coral_percent_prot, data = dat_select) 
summary(BetaGLM3) # best beta GLM

BetaGLM4 <- betareg(eco_sens ~ eez_percent_prot, data = dat_select) 
summary(BetaGLM4)

AIC(BetaGLM, BetaGLM2, BetaGLM3, BetaGLM4)
anova(BetaGLM, BetaGLM2, BetaGLM3, BetaGLM4)

Beta_best <- BetaGLM3

Beta_best$pseudo.r.squared
RsqGLM(gaussian_best) #This is an approximation for an Rsqard
RsqGLM(QB_best) #This is an approximation for an Rsqard


## It looks like the quasibinomial model might be the best based on Rsquared. 

```


## Ecological Recovery
```{r Ecologial Recovery, echo=TRUE}
### Create df for eco_recov
dat_select_erp <- dat %>%
  na.omit() %>%
  dplyr::select(eco_recov, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_erp <- glm(eco_recov ~ ., data = dat_select_erp)# Model with all Xs included
Dsquared(results_erp)  # explained deviance with all Xs included
plot(results_erp) #all Xs included
summary(results_erp) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_erp, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_erp <- glm(eco_recov ~ wgi_score, data = dat_select_erp)
Dsquared(LowestAIC_erp)  # explained deviance with all Xs included
plot(LowestAIC_erp) #all Xs included
summary(LowestAIC_erp) #all Xs included

anova(results_erp, LowestAIC_erp, test = "Chisq") ## not significantly better

### set null model
null_erp <- glm(eco_recov ~ 1, data = dat_select_erp, family = gaussian(link = "identity"))
```

### Gaussian error structure (Ecological Recovery)
```{r}
### Gaussian full model
gaussian_erp <- glm(eco_recov ~ ., data = dat_select_erp, family = gaussian(link = "identity"))
Dsquared(gaussian_erp)
RsqGLM(gaussian_erp) 
vif(gaussian_erp) # all values below 1.5
plot(gaussian_erp) # all Xs included
summary(gaussian_erp) # all Xs included

# Comparing full model to the null
anova(null_erp, gaussian_erp, test = "Chisq")  # a decrease in deviance but a non-significant pvalue is a non-significant improvement

# model adequacy (values above 0.05 make an adequate model)
pchisq(0.085511 - 0.057259, gaussian_erp$df.null - gaussian_erp$df.residual, lower.tail = FALSE) ## 0.9999

# stepwise backward removal and addition of variables
stepAIC(gaussian_erp, direction = "both")

# Best non-null AIC model
gaussian2_erp <- glm(eco_recov ~ wgi_score, data = dat_select_erp, family = gaussian(link = "identity")) 
Dsquared(gaussian2_erp) # very low explained deviance (less than full model)
RsqGLM(gaussian2_erp) # This is an approximation for an Rsqard

# Comparing new model to the null
anova(null_erp, gaussian2_erp, test = "Chisq")  # decrease in residual deviance but a non-significant pvalue is a non-significant improvement from the previous model. When there isn't much of an improvment but the p values in the summary table are non-significant then should always pick the simplest model --> null model is better than gaussian2_erp 

### Best Gaussian model is null model
gaussian_best_erp = null_erp
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.058281, gaussian_best_erp$df.residual, lower.tail = FALSE)
```
The best Gaussian model is the null model

### Quasibinomial error structure (Ecological Recovery)
```{r}
# Create full model
QB_erp <- glm(eco_recov ~ ., data = dat_select_erp, family = quasibinomial)
Dsquared(QB_erp)
RsqGLM(QB_erp) #This is an approximation for an Rsqard
plot(QB_erp) #all Xs included
summary.glm(QB_erp) #all Xs 

### Create QB null
qb_null_erp <- glm(eco_recov ~ 1, data = dat_select_erp, family = quasibinomial)

### Run anova between full QB model and Gaussian null
anova(null_erp, QB_erp, test = "Chisq")  # an increase in residual deviance means a worse-fit model, a high pvalue is a non-significant model

### Anova between full and null QB
anova(qb_null_erp, QB_erp, test = "Chisq") ## doesn't perform better than QB null

### anova between Gaussian and QB nulls
anova(null_erp, qb_null_erp, test = "Chisq") ### qb null does not perform better than Gaussian null

# model adequacy (values above 0.05 make an adequate model)
pchisq(0.37664, QB_erp$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables of full QB model
drop1(QB_erp) ### shouldn't drop any of them (because deviance increases in all cases)
### looks like QB is not a good model for ecological recovery potential
```
Looks like quasibinomial error structures don't perform well for eco_recov. The full quasibinomial model does not fit better than the null Gaussian model or the null quasibinomial model.

### Beta error structure (Ecological Recovery)
```{r}
### Full model with beta error
BetaGLM_erp <- betareg(eco_recov ~., data = dat_select_erp) 
summary(BetaGLM_erp) #all Xs 

### Manually run through alternative models and look at the p values and the coefficients 
### 3 variables (drop coral_percent_prot)
BetaGLM2_erp <- betareg(eco_recov ~ eez_percent_prot + fish_reg_total + wgi_score, data = dat_select_erp) 
summary(BetaGLM2_erp)

### 2 variables
BetaGLM3_erp <- betareg(eco_recov ~ eez_percent_prot + wgi_score, data = dat_select_erp) 
summary(BetaGLM3_erp) # best beta GLM

BetaGLM4_erp <- betareg(eco_recov ~ eez_percent_prot + fish_reg_total, data = dat_select_erp) 
summary(BetaGLM4_erp)

BetaGLM5_erp <- betareg(eco_recov ~ fish_reg_total + wgi_score, data = dat_select_erp) 
summary(BetaGLM5_erp)

### Single variable
BetaGLM6_erp <- betareg(eco_recov ~ wgi_score, data = dat_select_erp)
summary(BetaGLM6_erp)

BetaGLM7_erp <- betareg(eco_recov ~ eez_percent_prot, data = dat_select_erp) 
summary(BetaGLM7_erp)

BetaGLM8_erp <- betareg(eco_recov ~ coral_percent_prot, data = dat_select_erp) 
summary(BetaGLM8_erp)

BetaGLM9_erp <- betareg(eco_recov ~ fish_reg_total, data = dat_select_erp) 
summary(BetaGLM9_erp)

### Compare AICs
AIC(BetaGLM_erp, BetaGLM2_erp, BetaGLM3_erp, BetaGLM4_erp,
    BetaGLM5_erp, BetaGLM6_erp, BetaGLM7_erp, BetaGLM8_erp,
    BetaGLM9_erp)
### BetaGLM6_erp (just wgi_score) has the lowest AIC

### Test performance of BetaGLM6_erp
anova(null_erp, BetaGLM6_erp, test = "Chisq") 
pchisq(0.37664, BetaGLM6_erp$df.residual, lower.tail = FALSE)

### Run anovas
# anova(BetaGLM_erp, BetaGLM2_erp, BetaGLM3_erp, BetaGLM4_erp) ## getting an error that you can't use anova with betareg
```

The best-fit model with a beta error structure is eco_recov ~ wgi_score. However, it has a very low pseudo R-squared value (0.0085).


## Socioeconomic Exposure (Ecological Vulnerability)
```{r Ecologial Vulnerability, echo=TRUE}
### df for socioeconomic exposure
dat_select_se <- dat %>%
  na.omit() %>%
  dplyr::select(eco_vul, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_se <- glm(eco_vul ~ ., data = dat_select_se) # Model with all Xs included
Dsquared(results_se)  # explained deviance with all Xs included
plot(results_se) #all Xs included
summary(results_se) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_se, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_se <- glm(eco_vul ~ eez_percent_prot, data = dat_select_se)
Dsquared(LowestAIC_se)  # explained deviance with all Xs included
plot(LowestAIC_se) #all Xs included
summary(LowestAIC_se) #all Xs included

### ANOVA between full and lowest AIC
anova(results_se, LowestAIC_se, test = "Chisq")

### null for normal error
null_normal_se <- glm(eco_vul ~ 1, data = dat_select_se)
### anova
anova(null_normal_se, results_se, LowestAIC_se, test = "Chisq")
```
The full model (all covariates included, using a normal error structure) has a D2 value of 0.08; none of the covariates have significant coefficients. The full model does not perform better than the null model.

The model with the lowest AIC (aside from the null model) is socioeconomic_exposure ~ eez_percent_prot (D2 = 0.07), but it is not a better model than the full model.


### Gaussian error structure (Socioeconomic exposure)
```{r}
### Gaussian null model
null_se <- glm(eco_vul ~ 1, data = dat_select_se, family = gaussian(link = "identity"))

### Gaussian full model
gaussian_se <- glm(eco_vul ~ ., data = dat_select_se, family = gaussian(link = "identity"))
Dsquared(gaussian_se)
RsqGLM(gaussian_se) 
vif(gaussian_se) # all values below 1.5
plot(gaussian_se) # all Xs included
summary(gaussian_se) # all Xs included

# Comparing full model to the null
anova(null_se, gaussian_se, test = "Chisq")  # a decrease in deviance but a non-significant pvalue is a non-significant improvement

# model adequacy (values above 0.05 make an adequate model)
pchisq(0.085511 - 0.057259, gaussian_se$df.null - gaussian_se$df.residual, lower.tail = FALSE) ## 0.9999

# stepwise backward removal and addition of variables
stepAIC(gaussian_se, direction = "both")

# Best non-null AIC model
gaussian2_se <- glm(eco_vul ~ eez_percent_prot, data = dat_select_se, family = gaussian(link = "identity")) 
Dsquared(gaussian2_se) # very low explained deviance (less than full model)
RsqGLM(gaussian2_se) # This is an approximation for an Rsqard

# Comparing new model to the null
anova(null_se, gaussian2_se, test = "Chisq")  # decrease in residual deviance but a non-significant pvalue is a non-significant improvement from the previous model. When there isn't much of an improvment but the p values in the summary table are non-significant then should always pick the simplest model --> null model is better than gaussian2_erp 

### Best Gaussian model is null model
gaussian_best_erp <- null_erp
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.058281, gaussian_best_erp$df.residual, lower.tail = FALSE)
```
The full Gaussian model D2 = 0.08. All VIF values are below 1.5. The full model has lower residual deviance than the null Gaussian model (but p = 0.79, so not signficant).

The Gaussian model with the lowest AIC (besides the null model) is se_exposure ~ eez_percent_prot (D2 = 0.066). It is not an improvement over the null model (it has slightly lower residual deviance but p = 0.21). The best-fit Gaussian model is thus the null model.

### Quasibinomial error structure (Socioeconomic exposure)
```{r}
# Create full model
QB_se <- glm(eco_vul ~ ., data = dat_select_se, family = quasibinomial)
Dsquared(QB_se)
RsqGLM(QB_se) 
plot(QB_se)
summary.glm(QB_se) 

### Create QB null
qb_null_se <- glm(eco_vul ~ 1, data = dat_select_se, family = quasibinomial)

### Run anova between full QB model and Gaussian null
anova(null_se, QB_se, test = "Chisq")  # an increase in residual deviance means a worse-fit model, a high pvalue is a non-significant model

### Run anova between full and null QBs
anova(qb_null_se, QB_se, test = "Chisq")

### Anova between full and null QB
anova(qb_null_erp, QB_erp, test = "Chisq") ## doesn't perform better than QB null

### anova between Gaussian and QB nulls
anova(null_se, qb_null_se, test = "Chisq") ### qb null does not perform better than Gaussian null

# model adequacy (values above 0.05 make an adequate model)
pchisq(0.37664, QB_se$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables of full QB model
drop1(QB_se) ### shouldn't drop any of them (because deviance increases in all cases)
### looks like QB is not a good model for ecological recovery potential
```
The full quasibinomial model has a D2 of 0.077. It does not perform better than the Gaussian null (increases residual deviance) or the null QB model (slightly lower residual deviance but insignificant p value). The QB null does not perform as well as the Gaussian null. drop1() does not suggest dropping any variables. Looks like QB is not a good fit.


### Beta error structure (Socioeconomic exposure)
```{r}
### Full model with beta error
BetaGLM_se <- betareg(eco_vul ~., data = dat_select_se) 
summary(BetaGLM_se)

### Null model with beta error
BetaGLM_null_se <- betareg(eco_vul ~ 1, data = dat_select_se) 
summary(BetaGLM_null_se)

### Manually run through alternative models and look at the p values and the coefficients 
### 3 variables (drop coral_percent_prot)
BetaGLM2_se <- betareg(eco_vul ~ eez_percent_prot + fish_reg_total + wgi_score, data = dat_select_se) 
summary(BetaGLM2_se)

### 2 variables (drop eez_percent_prot)
BetaGLM3_se <- betareg(eco_vul ~ fish_reg_total + wgi_score, data = dat_select_se) 
summary(BetaGLM3_se) # best beta GLM

### Single variable
BetaGLM4_se <- betareg(eco_vul ~ wgi_score, data = dat_select_se)
summary(BetaGLM4_se)

BetaGLM5_se <- betareg(eco_vul ~ eez_percent_prot, data = dat_select_se) 
summary(BetaGLM5_se)

BetaGLM6_se <- betareg(eco_vul ~ coral_percent_prot, data = dat_select_se) 
summary(BetaGLM6_se)

BetaGLM7_se <- betareg(eco_vul ~ fish_reg_total, data = dat_select_se) 
summary(BetaGLM7_se)

### Compare AICs
AIC(BetaGLM_se, BetaGLM2_se, BetaGLM3_se, BetaGLM4_se,
    BetaGLM5_se, BetaGLM6_se, BetaGLM7_se, BetaGLM_null_se)
### BetaGLM6_erp (just wgi_score) has the lowest AIC

### Test performance of BetaGLM5_se
anova(null_se, BetaGLM5_se, test = "Chisq") 
pchisq(0.37664, BetaGLM5_se$df.residual, lower.tail = FALSE)
```
The beta model with the lowest AIC is the null model, followed by the model with just eez_percent_prot.

## Social Sensitivity
```{r Social Sensitivity, echo=TRUE}
### df for socioeconomic sensitivity
head(dat)
dat_select_ss <- dat %>%
  na.omit() %>%
  dplyr::select(soc_sen, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_ss <- glm(soc_sen ~ ., data = dat_select_ss)# Model with all Xs included
Dsquared(results_ss)  # explained deviance with all Xs included
plot(results_ss) #all Xs included
summary(results_ss) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_ss, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_ss <- glm(soc_sen ~ wgi_score, data = dat_select_ss)
Dsquared(LowestAIC_ss)  # explained deviance with all Xs included
plot(LowestAIC_ss) #all Xs included
summary(LowestAIC_ss) #all Xs included
```

### Gaussian error structure (Socioeconomic sensitivity)
```{r}

```

### Quasibinomial error structure (Socioeconomic sensitivity)
```{r}

```

### Beta error structure (Socioeconomic sensitivity)
```{r}

```


## Social Adaptive Capacity
```{r Social Adaptive Capacity, echo=TRUE}
### df for social adaptive capacity
head(dat)
dat_select_sac <- dat %>%
  na.omit() %>%
  dplyr::select(soc_ac, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_sac <- glm(soc_ac ~ ., data = dat_select_sac)# Model with all Xs included
Dsquared(results_sac)  # explained deviance with all Xs included
plot(results_sac) #all Xs included
summary(results_sac) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_sac, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_sac <- glm(soc_ac ~ fish_reg_total, data = dat_select_sac)
Dsquared(LowestAIC_sac)  # explained deviance with all Xs included
plot(LowestAIC_sac) #all Xs included
summary(LowestAIC_sac) #all Xs included
```

### Gaussian error structure (Socioeconomic adaptive capacity)
```{r}

```

### Quasibinomial error structure (Socioeconomic adaptive capacity)
```{r}

```

### Beta error structure (Socioeconomic adaptive capacity)
```{r}

```


## Social-Ecological Vulnerability
```{r Social , echo=TRUE}
### df
head(dat)
dat_select_sev <- dat %>%
  na.omit() %>%
  dplyr::select(se_vul, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_sev <- glm(se_vul ~ ., data = dat_select_sev)# Model with all Xs included
Dsquared(results_sev)  # explained deviance with all Xs included
plot(results_sev) #all Xs included
summary(results_sev) #all Xs 

#stepwise backward removal and addition of variables
stepAIC(results_sev, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_sev <- glm(se_vul ~ fish_reg_total, data = dat_select_sev)
Dsquared(LowestAIC_sev)  # explained deviance with all Xs included
plot(LowestAIC_sev) #all Xs included
summary(LowestAIC_sev) #all Xs included
```

### Gaussian error structure (Social-Ecological Vulnerability)
```{r}

```

### Quasibinomial error structure (Social-Ecological Vulnerability)
```{r}

```

### Beta error structure (Social-Ecological Vulnerability)
```{r}

```

