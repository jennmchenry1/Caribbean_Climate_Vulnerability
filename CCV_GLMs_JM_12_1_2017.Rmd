---
title: "GLM of SEV scores"
author: "Jenn_McHenry"
date: "December 1, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(MASS)
library(car)
library(modEvA)
library(betareg)
library(gamlss)
```

# Initial examination of x and y parameters
```{r cars}
dat <- read.csv("vulnerability_covariates.csv")

head(dat)

summary(dat)
```

```{r visualizing data distribution}

head(dat)
names(dat)

boxplot(dat[c(3:8)])

#Normality test
?shapiro.test
shapiro.test(dat$eco_sens) #normal
shapiro.test(dat$eco_recov) #normal 
shapiro.test(dat$eco_vul) #normal
shapiro.test(dat$soc_sen) #normal
shapiro.test(dat$soc_ac) #non-normal if using 0.05, normal if using 0.01
shapiro.test(dat$se_vul) #non-normal if using 0.05, normal if using 0.01

```

## Ecological Sensitivity

```{r Ecologial Sensitivity, echo=TRUE}
dat_select < -dat %>%
  na.omit() %>%
  dplyr::select(eco_sens, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

summary(dat_select$eco_exp)
```

### Gaussian error structure (Ecological Sensitivity)
```{r}
### Set null model (no covariates)
null <- glm(eco_sens ~ 1, data = dat_select, family = gaussian(link = "identity"))

### Build model with all covariates included
gaussian <- glm(eco_sens ~ ., data = dat_select, family = gaussian(link = "identity"))

### Assess model fit
Dsquared(gaussian)
RsqGLM(gaussian) # This is an approximation for an Rsqard

### Check for multicollinearity
vif(gaussian) # values for each variable closer to one indicate no multicollinearity.  Higher values closer to 10 indicate the variable may be correlated with another explanatory variable.

### Visualize full model
plot(gaussian) #all Xs included
summary(gaussian) #all Xs included

#Comparing new model to the null
anova(null, gaussian, test = "Chisq")  # an increase in residual deviance and a non-significant pvalue is a non-significant improvement

#model adequacy (values above 0.05 make an adequate model)
pchisq(0.085511-0.057259, gaussian$df.null-gaussian$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables
stepAIC(gaussian, direction = "both")

#g2
gaussian2 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score, 
                 data = dat_select, family = gaussian(link = "identity"))
Dsquared(gaussian2) # this is the explained deviance
RsqGLM(gaussian2) #This is an approximation for an Rsqard
plot(gaussian2) #plots for lower AIC model
summary(gaussian2) #summary of lowest AIC model

#g3 (model with lowest AIC)
gaussian3 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot, 
                 data = dat_select, family = gaussian(link = "identity"))
Dsquared(gaussian3) # less explained deviance than the null
RsqGLM(gaussian3) #This is an approximation for an Rsqard
plot(gaussian3) #plots for lower AIC model
summary(gaussian3) #summary of lowest AIC model

drop1(gaussian3) # just a check to make sure you shouldn't remove any more

#Comparing new models to the null
anova(null, gaussian2, gaussian3, test = "Chisq")  # an increase in residual deviance and a non-significant pvalue is a non-significant improvement from the previous model. When there isn't much of an improvment but the p values in the summary table are non-significant then should always pick the simplest model. 

### Assign Gaussian best model
gaussian_best <- gaussian3
summary(gaussian_best)
cr.plots(gaussian_best)
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.058281, gaussian_best$df.residual, lower.tail = FALSE)
```

### Quasibinomial error structure (Ecological Sensitivity)
```{r}
### Set full model using QB error structure
QB <- glm(eco_sens ~ ., data = dat_select, family = quasibinomial) # Model with all Xs included
Dsquared(QB)
RsqGLM(QB) #This is an approximation for an Rsqard
plot(QB) #all Xs included
summary.glm(QB) #all Xs 

anova(null, QB, test = "Chisq")  # an increase in deviance means a non-significant model, a high pvalue is a non-significant model

#model adequacy (values above 0.05 make an adequate model)
pchisq(0.37664, QB$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables of full QB model
drop1(QB)  ##have to do it this way rather than stepAIC because apparently AIC can't be calculated from a QB model. If removal of a term increases the residual deviance, then it is not the best variable to remove

#QB2
QB2 <- glm(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score,
           data = dat_select,family = quasibinomial)
Dsquared(QB2)
RsqGLM(QB2) #This is an approximation for an Rsqard
summary(QB2)
anova(QB, QB2, test = "Chisq") # an increase in deviance means a non-significant model, a high pvalue is a non-significant model
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.3767, QB2$df.residual, lower.tail = FALSE)

drop1(QB2)

#QB3
QB3=glm(eco_sens ~ eez_percent_prot + coral_percent_prot,
        data = dat_select,family = quasibinomial)
Dsquared(QB3)
RsqGLM(QB3) #This is an approximation for an Rsqard
summary(QB3)
pchisq(0.3860, QB2$df.residual, lower.tail = FALSE) #model adequacy (values above 0.05 make an adequate model)


drop1(QB3)

QB_best=QB3
anova(null, QB_best, test = "Chisq") # an increase in deviance means a non-significant model, a high pvalue is a non-significant model
```

### Beta error structure (Ecological Sensitivity)
```{r}
BetaGLM <- betareg(eco_sens ~., data = dat_select) 
plot(BetaGLM) #all Xs included
summary(BetaGLM) #all Xs 

#I couldn't find a stepwise function for beta-regression so I did it by hand just looking at the p values and the coefficients. 
BetaGLM2 <- betareg(eco_sens ~ eez_percent_prot + coral_percent_prot + wgi_score, data = dat_select) 
summary(BetaGLM2)

BetaGLM3 <- betareg(eco_sens ~ eez_percent_prot + coral_percent_prot, data = dat_select) 
summary(BetaGLM3) # best beta GLM

BetaGLM4 <- betareg(eco_sens ~ eez_percent_prot, data = dat_select) 
summary(BetaGLM4)

AIC(BetaGLM, BetaGLM2, BetaGLM3, BetaGLM4)
anova(BetaGLM, BetaGLM2, BetaGLM3, BetaGLM4)

Beta_best <- BetaGLM3

Beta_best$pseudo.r.squared
RsqGLM(gaussian_best) #This is an approximation for an Rsqard
RsqGLM(QB_best) #This is an approximation for an Rsqard


## It looks like the quasibinomial model might be the best based on Rsquared. 

```


## Ecological Recovery
```{r Ecologial Recovery, echo=TRUE}
### Create df for eco_recov
dat_select_erp < -dat %>%
  na.omit() %>%
  dplyr::select(eco_recov, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

### Full model
results_erp <- glm(eco_recov ~ ., data = dat_select_erp)# Model with all Xs included
Dsquared(results_erp)  # explained deviance with all Xs included
plot(results_erp) #all Xs included
summary(results_erp) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_erp, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_erp <- glm(eco_recov ~ wgi_score, data = dat_select_erp)
Dsquared(LowestAIC_erp)  # explained deviance with all Xs included
plot(LowestAIC_erp) #all Xs included
summary(LowestAIC_erp) #all Xs included

### set null model
null_erp <- glm(eco_recov ~ 1, data = dat_select_erp, family = gaussian(link = "identity"))
```

### Gaussian error structure (Ecological Recovery)
```{r}
### Gaussian full model
gaussian_erp <- glm(eco_recov ~ ., data = dat_select_erp, family = gaussian(link = "identity"))
Dsquared(gaussian_erp)
RsqGLM(gaussian_erp) 
vif(gaussian_erp) # values for each variable closer to one indicate no multicolinaerity.  Higher values closer to 10 indicate the variable may be correlated with another explanatory variable.
plot(gaussian_erp) # all Xs included
summary(gaussian_erp) # all Xs included

# Comparing full model to the null
anova(null_erp, gaussian_erp, test = "Chisq")  # an decrease in deviance but a non-significant pvalue is a non-significant improvement

# model adequacy (values above 0.05 make an adequate model)
pchisq(0.085511 - 0.057259, gaussian_erp$df.null - gaussian_erp$df.residual, lower.tail = FALSE)

# stepwise backward removal and addition of variables
stepAIC(gaussian_erp, direction = "both")

# g2
gaussian2_erp <- glm(eco_recov ~ wgi_score, data = dat_select_erp, family = gaussian(link = "identity")) 
Dsquared(gaussian2_erp) # very low explained deviance
RsqGLM(gaussian2_erp) # This is an approximation for an Rsqard

drop1(gaussian2) # should not add additiona variables

# Comparing new models to the null
anova(null_erp, gaussian2_erp, test = "Chisq")  # a decrease in residual deviance but a non-significant pvalue is a non-significant improvement from the previous model. When there isn't much of an improvment but the p values in the summary table are non-significant then should always pick the simplest model. 

gaussian_best_erp = gaussian2_erp
#model adequacy (values above 0.05 make an adequate model)
pchisq(0.058281, gaussian_best_erp$df.residual, lower.tail = FALSE)
```


### Quasibinomial error structure (Ecological Recovery)
```{r}
#Quasibinomial Errors
QB_erp <- glm(eco_recov ~ ., data = dat_select_erp, family = quasibinomial) # Model with all Xs included
Dsquared(QB_erp)
RsqGLM(QB_erp) #This is an approximation for an Rsqard
plot(QB_erp) #all Xs included
summary.glm(QB_erp) #all Xs 

anova(null_erp, QB_erp, test = "Chisq")  # an increase in deviance means a non-significant model, a high pvalue is a non-significant model

#model adequacy (values above 0.05 make an adequate model)
pchisq(0.37664, QB_erp$df.residual, lower.tail = FALSE)

#stepwise backward removal and addition of variables of full QB model
drop1(QB_erp) ### shouldn't drop any of them
### looks like QB is not a good model for ecological recoveyr potential
```

### Beta error structure (Ecological Recovery)
```{r}
### Beta error structure
#Beta Distribution Errors
BetaGLM_erp <- betareg(eco_recov ~., data = dat_select_erp) 
summary(BetaGLM_erp) #all Xs 

### look at the p values and the coefficients 
BetaGLM2_erp <- betareg(eco_recov ~ eez_percent_prot + fish_reg_total + wgi_score, data = dat_select_erp) 
summary(BetaGLM2_erp)

BetaGLM3_erp <- betareg(eco_recov ~ eez_percent_prot + wgi_score, data = dat_select_erp) 
summary(BetaGLM3_erp) # best beta GLM

BetaGLM4_erp <- betareg(eco_recov ~ wgi_score, data = dat_select_erp) 
summary(BetaGLM4_erp)

AIC(BetaGLM_erp, BetaGLM2_erp, BetaGLM3_erp, BetaGLM4_erp)
anova(BetaGLM_erp, BetaGLM2_erp, BetaGLM3_erp, BetaGLM4_erp) ## getting an error that you can't use anova with betareg
```


## Socioeconomic Exposure (Ecological Vulnerability)
```{r Ecologial Vulnerability, echo=TRUE}
dat_select_se <- dat %>%
  na.omit() %>%
  dplyr::select(eco_vul, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

results_se <- glm(eco_vul ~ ., data = dat_select_se)# Model with all Xs included
Dsquared(results_se)  # explained deviance with all Xs included
plot(results_se) #all Xs included
summary(results_se) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_se, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_se <- glm(eco_vul ~ eez_percent_prot, data = dat_select_se)
Dsquared(LowestAIC_se)  # explained deviance with all Xs included
plot(LowestAIC_se) #all Xs included
summary(LowestAIC_se) #all Xs included

```

### Gaussian error structure (Socioeconomic exposure)
### Quasibinomial error structure (Socioeconomic exposure)
### Beta error structure (Socioeconomic exposure)

## Social Sensitivity
```{r Social Sensitivity, echo=TRUE}
head(dat)
dat_select_ss <- dat %>%
  na.omit() %>%
  dplyr::select(soc_sen, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

results_ss <- glm(soc_sen ~ ., data = dat_select_ss)# Model with all Xs included
Dsquared(results_ss)  # explained deviance with all Xs included
plot(results_ss) #all Xs included
summary(results_ss) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_ss, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_ss <- glm(soc_sen ~ wgi_score, data = dat_select_ss)
Dsquared(LowestAIC_ss)  # explained deviance with all Xs included
plot(LowestAIC_ss) #all Xs included
summary(LowestAIC_ss) #all Xs included
```
### Gaussian error structure (Socioeconomic sensitivity)
### Quasibinomial error structure (Socioeconomic sensitivity)
### Beta error structure (Socioeconomic sensitivity)

## Social Adaptive Capacity

```{r Social Adaptive Capacity, echo=TRUE}
head(dat)
dat_select_sac <- dat %>%
  na.omit() %>%
  dplyr::select(soc_ac, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

results_sac <- glm(soc_ac ~ ., data = dat_select_sac)# Model with all Xs included
Dsquared(results_sac)  # explained deviance with all Xs included
plot(results_sac) #all Xs included
summary(results_sac) #all Xs included

#stepwise backward removal and addition of variables
stepAIC(results_sac, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_sac <- glm(soc_ac ~ fish_reg_total, data = dat_select_sac)
Dsquared(LowestAIC_sac)  # explained deviance with all Xs included
plot(LowestAIC_sac) #all Xs included
summary(LowestAIC_sac) #all Xs included
```
### Gaussian error structure (Socioeconomic adaptive capacity)
### Quasibinomial error structure (Socioeconomic adaptive capacity)
### Beta error structure (Socioeconomic adaptive capacity)


## Social-Ecological Vulnerability
```{r Social , echo=TRUE}
head(dat)
dat_select_sev <- dat %>%
  na.omit() %>%
  dplyr::select(se_vul, eez_percent_prot, coral_percent_prot, fish_reg_total, wgi_score)

results_sev <- glm(se_vul ~ ., data = dat_select_sev)# Model with all Xs included
Dsquared(results_sev)  # explained deviance with all Xs included
plot(results_sev) #all Xs included
summary(results_sev) #all Xs 



#stepwise backward removal and addition of variables
stepAIC(results_sev, direction = "both")

#lowest AIC model that isn't the null model
LowestAIC_sev <- glm(se_vul ~ fish_reg_total, data = dat_select_sev)
Dsquared(LowestAIC_sev)  # explained deviance with all Xs included
plot(LowestAIC_sev) #all Xs included
summary(LowestAIC_sev) #all Xs included

```

### Gaussian error structure (Social-Ecological Vulnerability)
### Quasibinomial error structure (Social-Ecological Vulnerability)
### Beta error structure (Social-Ecological Vulnerability)